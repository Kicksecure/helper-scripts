#!/bin/bash

## Copyright (C) 2025 - 2025 ENCRYPTED SUPPORT LLC <adrelanos@whonix.org>
## See the file COPYING for copying conditions.

set -o errexit
set -o nounset
set -o errtrace
set -o pipefail

export LC_ALL='C'

# shellcheck source=../libexec/helper-scripts/log_run_die.sh
source /usr/libexec/helper-scripts/log_run_die.sh

# shellcheck source=../libexec/helper-scripts/as_root.sh
source /usr/libexec/helper-scripts/as_root.sh

# shellcheck source=../libexec/helper-scripts/has.sh
source /usr/libexec/helper-scripts/has.sh

# shellcheck source=../libexec/helper-scripts/secure_boot_enabled_check.bsh
source /usr/libexec/helper-scripts/secure_boot_enabled_check.bsh

# shellcheck source=../sbin/shim-signed-mok-setup
source /usr/sbin/shim-signed-mok-setup

usage() {
  log notice "Usage: $0 [-n|--non-interactive]"
  log notice "  -n, --non-interactive   Do not ask for user input (assume yes)."
}

return_maybe() {
  if [ "$dev_mode" = "true" ]; then
    log notice "DEVELOPMENT: Ignoring non-zero return code in --dev mode."
    return 0
  fi
  return 1
}

dev_mode="false"
non_interactive="false"

while [ "$#" -gt 0 ]; do
  case "$1" in
    -n|--non-interactive)
      non_interactive="true"
      shift
      ;;
     --dev)
      dev_mode="true"
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    --)
      shift
      break
      ;;
    *)
      log error "Unknown option: $1"
      usage
      exit 1
      ;;
  esac
done

see_also() {
  log notice "See also:"
  printf '%s\n' "https://www.kicksecure.com/wiki/Secure_Boot"
}

shim_enroll_mok() {
  local do_generate_mok mokutil_sbstate_output \
    secure_boot_enabled_check_retcode reason mokutil_test_key_output

  as_root
  dkms_mok_variables_set

  if ! has dkms; then
    log error "Missing required tool: 'dkms' (Dynamic Kernel Module Support)."
    log error "Without it, DKMS signing keys cannot be prepared. Please install 'dkms' and run this tool again."
    see_also
    return 1
  fi
  if ! has mokutil; then
    log error "Missing required tool: 'mokutil' (manages Machine Owner Keys (MOK) for shim and Secure Boot)."
    log error "Without it, Secure Boot state cannot be checked and keys cannot be enrolled. Please install 'mokutil' and run this tool again."
    see_also
    return 1
  fi

  if ! [ -d /sys/firmware/efi ]; then
    if test -e /usr/share/qubes/marker-vm; then
      reason="Not booted in EFI (UEFI) mode. Secure Boot is only available in EFI (UEFI) mode. Qubes detected. Qubes issue:
https://github.com/QubesOS/qubes-issues/issues/5241"
    else
      reason="Not booted in EFI (UEFI) mode. Secure Boot is only available in EFI (UEFI) mode."
    fi
    log notice "$reason
Therefore Secure Boot is unavailable and there is no need to set up or enroll a MOK. Exiting, ok."
    see_also
    return_maybe 0
  fi

  secure_boot_enabled_check_retcode='0'
  mokutil_sbstate_output="$(check_secure_boot_enabled)" || secure_boot_enabled_check_retcode="$?"
  if [ "${secure_boot_enabled_check_retcode}" = '1' ]; then
    log notice "Secure Boot is disabled, therefore no need to set up or enroll a MOK. Exiting, ok."
    return_maybe 0
  elif [ "${secure_boot_enabled_check_retcode}" = '2' ]; then
    log warn "Cannot detect Secure Boot state! Exiting."
    log warn "'mokutil --sb-state' output:"
    printf '%s\n' "${mokutil_sbstate_output}"
    see_also
    return_maybe 1
  fi
  log notice "Secure Boot is enabled."

  ## Confusingly, 'mokutil --test-key' returns 1 if the key is already
  ## enrolled, and 0 if it is not.
  if [ -f "${dkms_mok_public_file}" ] \
    && ! mokutil_test_key_output="$(log_run notice mokutil --test-key "${dkms_mok_public_file}")"; then
    if [ "${mokutil_test_key_output}" = "${dkms_mok_public_file} is already enrolled" ]; then
      log notice "MOK already enrolled. Exiting, ok."
      return_maybe 0
    else
      log warn 'Cannot detect MOK enrollment state! Exiting.'
      log warn "'mokutil --test-key ${dkms_mok_public_file}' output:"
      printf '%s\n' "${mokutil_test_key_output}"
      see_also
      return_maybe 1
    fi
  fi

  log notice "
This tool will help you set up and enroll a Machine Owner Key (MOK).
A MOK is a signing key used by shim (the Secure Boot loader) to allow loading
third-party kernel modules (kernel drivers not built into the Linux kernel,
often installed via DKMS), while Secure Boot is enabled.

This is useful for software that relies on third-party kernel modules (such as
tirdad and VirtualBox) with Secure Boot enabled.

See also:
https://www.kicksecure.com/wiki/Secure_Boot
"

  if [ "${non_interactive}" = "true" ]; then
    log notice "Non-interactive mode selected (-n|--non-interactive). Proceeding with MOK setup and enrollment without asking for confirmation."
    do_generate_mok='yes'
  else
    if ! read -r -p 'QUESTION: Set up and start enrolling a MOK now? [y/yes/n/no] ' do_generate_mok; then
      log notice "No input available (for example, not running in a terminal). Exiting without setting up a MOK, ok."
      return 0
    fi

    case "${do_generate_mok,,}" in
      y|yes)
        true
        ;;
      n|no)
        log notice "Exiting without setting up a MOK, as requested by user, ok."
        return 0
        ;;
      *)
        log error "Invalid answer. Please type y/yes or n/no."
        return 1
        ;;
    esac
  fi

  log notice "Setting up MOK..."
  if ! log_run notice shim-signed-mok-setup; then
    log error "MOK setup failed! Exiting."
    return 1
  fi
  log notice "MOK setup succeeded, ok."

  log notice "\
$0: INFO: Enrolling MOK.
You will be prompted to create a password for enrollment (used by shim).
Choose a short, memorable password. You will only need it once, at the next
reboot, to finish the enrollment process."
  if ! log_run notice mokutil --import "${dkms_mok_public_file}"; then
    log error "MOK enrollment failed! Exiting."
    return 1
  fi

  log notice "\
$0: INFO: MOK enrollment started.
To finish the process:

1. Reboot the system.
2. When a blue 'SHIM UEFI key management' screen appears, press any key, then select 'Enroll MOK'.
3. Then select 'Continue'.
4. Confirm with 'Yes' when prompted.
5. After this, enter the password you set up just now.
6. At this point, you are done. Select 'Reboot'.

To view these steps on a different device, or for more information, see:
https://www.kicksecure.com/wiki/Secure_Boot#Secure_Boot_DKMS_Signing_Key_Enrollment"
}

shim_enroll_mok
